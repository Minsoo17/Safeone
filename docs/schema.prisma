// ============================================
// SafeOne (세이프원) - Database Schema
// 안전업체 ↔ 안전요원 매칭 플랫폼
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. 사용자 (User) - 공통 인증
// ============================================

enum UserRole {
  OFFICER   // 안전요원
  COMPANY   // 안전업체
  ADMIN     // 관리자
}

enum UserStatus {
  ACTIVE      // 활성
  SUSPENDED   // 정지
  WITHDRAWN   // 탈퇴
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  password      String      // 해시된 비밀번호
  role          UserRole
  status        UserStatus  @default(ACTIVE)
  
  // 본인인증 정보
  phone         String?     @unique
  phoneVerified Boolean     @default(false)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastLoginAt   DateTime?
  
  // 관계
  company       Company?
  officer       SafetyOfficer?
  
  @@index([email])
  @@index([role])
}

// ============================================
// 2. 안전업체 (Company)
// ============================================

enum SubscriptionTier {
  BRONZE  // 5만원 - 월 10건
  SILVER  // 10만원 - 월 30건
  GOLD    // 15만원 - 무제한
}

enum CompanyStatus {
  PENDING     // 인증 대기
  VERIFIED    // 인증 완료
  SUSPENDED   // 정지
}

model Company {
  id                  String          @id @default(cuid())
  userId              String          @unique
  user                User            @relation(fields: [userId], references: [id])
  
  // 기본 정보
  companyName         String          // 업체명
  representativeName  String          // 대표자명
  
  // 사업자 인증 (국세청 API)
  businessNumber      String          @unique  // 사업자등록번호
  openDate            DateTime                 // 개업일
  verifiedAt          DateTime?                // 인증 완료일
  status              CompanyStatus   @default(PENDING)
  
  // 연락처
  contactPhone        String?
  contactEmail        String?
  address             String?
  
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  // 관계
  subscriptions       Subscription[]
  jobPostings         JobPosting[]
  reviewsGiven        Review[]        @relation("CompanyReviews")    // 업체가 작성한 평가
  reviewsReceived     Review[]        @relation("ReviewsForCompany") // 업체가 받은 평가
  settlements         Settlement[]
  
  @@index([businessNumber])
  @@index([status])
}

// ============================================
// 3. 구독 (Subscription)
// ============================================

enum SubscriptionStatus {
  TRIAL     // 무료 체험 (1개월)
  ACTIVE    // 활성
  EXPIRED   // 만료
  CANCELLED // 취소
}

model Subscription {
  id              String              @id @default(cuid())
  companyId       String
  company         Company             @relation(fields: [companyId], references: [id])
  
  tier            SubscriptionTier    @default(SILVER)  // 무료 체험 시 실버
  status          SubscriptionStatus  @default(TRIAL)
  
  // 기간
  startDate       DateTime            @default(now())
  endDate         DateTime
  
  // 이번 달 매칭 사용량
  matchCountUsed  Int                 @default(0)
  matchCountLimit Int                 // BRONZE:10, SILVER:30, GOLD:무제한(-1)
  
  // 결제 정보
  amount          Int?                // 결제 금액 (원)
  paidAt          DateTime?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@index([companyId])
  @@index([status])
}

// ============================================
// 4. 안전요원 (SafetyOfficer)
// ============================================

enum OfficerStatus {
  PENDING     // 임시 승인 (자격증 형식 체크 통과)
  VERIFIED    // 검증 완료 (실제 활동 후)
  SUSPENDED   // 정지
  RESTRICTED  // 지원 제한 (노쇼 등)
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model SafetyOfficer {
  id                String          @id @default(cuid())
  userId            String          @unique
  user              User            @relation(fields: [userId], references: [id])
  
  // 기본 정보
  name              String
  birthDate         DateTime?
  gender            Gender?
  profileImage      String?         // 프로필 이미지 URL
  
  // 활동 지역
  preferredRegions  String[]        // ["서울", "경기", "인천"]
  
  // 자격증 정보 (대한적십자사 수료증)
  certificateNumber String?         // 수료번호
  certificateDate   DateTime?       // 수료일
  certificateImage  String?         // 수료증 이미지 URL (S3)
  certificateExpiry DateTime?       // 자격증 만료일
  
  status            OfficerStatus   @default(PENDING)
  verifiedAt        DateTime?
  
  // 페널티 관련
  warningCount      Int             @default(0)   // 경고 횟수
  cancelCount       Int             @default(0)   // 취소 횟수
  noShowCount       Int             @default(0)   // 노쇼 횟수
  restrictedUntil   DateTime?                     // 지원 제한 해제일
  
  // 자기소개
  introduction      String?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // 관계
  applications      Application[]
  reviewsGiven      Review[]        @relation("OfficerReviews")     // 요원이 작성한 평가
  reviewsReceived   Review[]        @relation("ReviewsForOfficer")  // 요원이 받은 평가
  settlements       Settlement[]
  
  @@index([status])
  @@index([preferredRegions])
}

// ============================================
// 5. 구인공고 (JobPosting)
// ============================================

enum JobPostingStatus {
  DRAFT       // 임시저장
  OPEN        // 모집중
  CLOSED      // 모집마감 (수동)
  COMPLETED   // 행사완료
  CANCELLED   // 취소됨
}

model JobPosting {
  id              String            @id @default(cuid())
  companyId       String
  company         Company           @relation(fields: [companyId], references: [id])
  
  // 행사 정보
  title           String            // 행사명 (예: "○○초등학교 제주 수학여행")
  description     String?           // 상세 안내
  
  // 일정
  eventStartDate  DateTime          // 행사 시작일
  eventEndDate    DateTime          // 행사 종료일
  
  // 장소
  gatheringPlace  String            // 집합 장소
  destination     String            // 목적지
  
  // 규모
  studentCount    Int               // 학생 수
  recruitCount    Int               // 모집 인원
  
  // 조건
  dailyWage       Int               // 일당 (원)
  provideMeals    Boolean           @default(true)   // 숙식 제공 여부
  preferences     String?           // 우대 조건
  
  // 상태
  status          JobPostingStatus  @default(OPEN)
  isUrgent        Boolean           @default(false)  // 긴급 구인 여부
  
  // 마감
  applicationDeadline DateTime?     // 지원 마감일
  closedAt        DateTime?         // 매칭 종료일
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // 관계
  applications    Application[]
  settlements     Settlement[]
  
  @@index([companyId])
  @@index([status])
  @@index([eventStartDate])
  @@index([destination])
}

// ============================================
// 6. 지원 (Application)
// ============================================

enum ApplicationStatus {
  APPLIED     // 지원중 (검토 대기)
  SELECTED    // 선발됨
  WAITING     // 대기
  REJECTED    // 선발마감 (미선발)
  CANCELLED   // 취소됨 (본인 취소)
}

model Application {
  id              String              @id @default(cuid())
  jobPostingId    String
  jobPosting      JobPosting          @relation(fields: [jobPostingId], references: [id])
  officerId       String
  officer         SafetyOfficer       @relation(fields: [officerId], references: [id])
  
  status          ApplicationStatus   @default(APPLIED)
  appliedAt       DateTime            @default(now())
  
  // 선발 관련
  selectedAt      DateTime?           // 선발 확정일
  applicationOrder Int?               // 지원 순서 (업체에게만 표시)
  
  // 취소 관련
  cancelledAt     DateTime?
  cancelReason    String?
  cancelApproved  Boolean?            // 업체 승인 여부
  
  // 메모 (업체용)
  companyNote     String?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // 관계
  settlement      Settlement?
  
  @@unique([jobPostingId, officerId])  // 같은 공고에 중복 지원 불가
  @@index([jobPostingId])
  @@index([officerId])
  @@index([status])
}

// ============================================
// 7. 평가 (Review)
// ============================================

enum ReviewType {
  COMPANY_TO_OFFICER  // 업체 → 안전요원
  OFFICER_TO_COMPANY  // 안전요원 → 업체
}

model Review {
  id              String        @id @default(cuid())
  type            ReviewType
  
  // 평가 대상 연결
  jobPostingId    String
  
  // 업체 → 요원 평가 시
  reviewerCompanyId   String?
  reviewerCompany     Company?       @relation("CompanyReviews", fields: [reviewerCompanyId], references: [id])
  reviewedOfficerId   String?
  reviewedOfficer     SafetyOfficer? @relation("ReviewsForOfficer", fields: [reviewedOfficerId], references: [id])
  
  // 요원 → 업체 평가 시
  reviewerOfficerId   String?
  reviewerOfficer     SafetyOfficer? @relation("OfficerReviews", fields: [reviewerOfficerId], references: [id])
  reviewedCompanyId   String?
  reviewedCompany     Company?       @relation("ReviewsForCompany", fields: [reviewedCompanyId], references: [id])
  
  // ===== 평가 항목 (1~5점) =====
  
  // [업체→요원] 평가 항목
  timePunctuality     Int?    // 시간 준수
  safetyManagement    Int?    // 안전 관리
  emergencyResponse   Int?    // 돌발 상황 대처
  studentCommunication Int?   // 학생 소통
  workAttitude        Int?    // 업무 태도
  
  // [요원→업체] 평가 항목
  paymentAccuracy     Int?    // 정산 정확성
  priorNotice         Int?    // 사전 안내
  onSiteSupport       Int?    // 현장 지원
  communication       Int?    // 소통
  reemploymentWilling Int?    // 재근무 의향
  
  // 종합
  averageScore        Float           // 평균 점수
  comment             String?         // 코멘트 (3점 이하 항목 있으면 필수)
  
  // 공개 관련
  isPublished         Boolean         @default(false)  // 공개 여부
  publishAt           DateTime?       // 공개 예정일 (작성 후 14일)
  
  // 수정
  editCount           Int             @default(0)     // 수정 횟수 (1회만 가능)
  editedAt            DateTime?
  
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  @@index([reviewedOfficerId])
  @@index([reviewedCompanyId])
  @@index([isPublished])
}

// ============================================
// 8. 정산 (Settlement)
// ============================================

enum SettlementStatus {
  PENDING           // 정산 대기 (행사 완료 후)
  COMPANY_PAID      // 업체 입금 완료
  OFFICER_PAID      // 요원 지급 완료
  DISPUTED          // 분쟁 중
  CANCELLED         // 취소됨
}

model Settlement {
  id              String            @id @default(cuid())
  applicationId   String            @unique
  application     Application       @relation(fields: [applicationId], references: [id])
  
  jobPostingId    String
  jobPosting      JobPosting        @relation(fields: [jobPostingId], references: [id])
  companyId       String
  company         Company           @relation(fields: [companyId], references: [id])
  officerId       String
  officer         SafetyOfficer     @relation(fields: [officerId], references: [id])
  
  // 금액
  amount          Int               // 정산 금액 (일당)
  
  // 상태
  status          SettlementStatus  @default(PENDING)
  
  // 업체 입금
  companyPaidAt   DateTime?         // 업체 입금일
  companyDueDate  DateTime          // 업체 입금 기한 (행사 종료 후 3일)
  
  // 요원 지급
  officerPaidAt   DateTime?         // 요원 지급일
  officerDueDate  DateTime?         // 요원 지급 기한 (입금 후 3일)
  
  // 요원 계좌 정보
  bankName        String?
  accountNumber   String?
  accountHolder   String?
  
  // 분쟁
  disputeReason   String?
  disputeResolvedAt DateTime?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([companyId])
  @@index([officerId])
  @@index([status])
}

// ============================================
// 9. 알림 (Notification)
// ============================================

enum NotificationType {
  // 매칭 관련
  APPLICATION_RECEIVED    // 지원 접수됨 (업체에게)
  APPLICATION_SELECTED    // 선발됨 (요원에게)
  APPLICATION_REJECTED    // 선발마감 (요원에게)
  APPLICATION_WAITING     // 대기 상태 (요원에게)
  
  // 취소 관련
  CANCEL_REQUESTED        // 취소 요청 (업체에게)
  CANCEL_APPROVED         // 취소 승인됨 (요원에게)
  EMERGENCY_CANCEL        // 긴급 취소 (관리자에게)
  
  // 정산 관련
  PAYMENT_REMINDER        // 입금 독촉 (업체에게)
  PAYMENT_RECEIVED        // 입금 완료 (요원에게)
  PAYMENT_COMPLETED       // 지급 완료 (요원에게)
  
  // 평가 관련
  REVIEW_REQUEST          // 평가 요청
  REVIEW_PUBLISHED        // 평가 공개됨
  
  // 시스템
  SUBSCRIPTION_EXPIRING   // 구독 만료 예정
  CERTIFICATE_EXPIRING    // 자격증 만료 예정
  
  // 긴급
  URGENT_RECRUITMENT      // 긴급 구인
  NO_SHOW                 // 노쇼 발생
}

model Notification {
  id          String            @id @default(cuid())
  userId      String
  type        NotificationType
  
  title       String
  message     String
  link        String?           // 클릭 시 이동할 경로
  
  isRead      Boolean           @default(false)
  readAt      DateTime?
  
  createdAt   DateTime          @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// 10. 분쟁/신고 (Dispute)
// ============================================

enum DisputeStatus {
  OPEN        // 접수됨
  REVIEWING   // 검토 중
  RESOLVED    // 해결됨
  DISMISSED   // 기각됨
}

enum DisputeType {
  PAYMENT           // 정산 분쟁
  NO_SHOW           // 노쇼 신고
  FAKE_CERTIFICATE  // 허위 자격증
  MISCONDUCT        // 부적절한 행동
  OTHER             // 기타
}

model Dispute {
  id              String          @id @default(cuid())
  
  type            DisputeType
  status          DisputeStatus   @default(OPEN)
  
  // 신고자
  reporterUserId  String
  reporterRole    UserRole
  
  // 피신고자
  reportedUserId  String
  reportedRole    UserRole
  
  // 관련 정보
  jobPostingId    String?
  applicationId   String?
  settlementId    String?
  
  // 내용
  title           String
  description     String
  evidence        String[]        // 증거 파일 URL 목록
  
  // 처리
  adminNote       String?         // 관리자 메모
  resolution      String?         // 처리 결과
  resolvedAt      DateTime?
  resolvedBy      String?         // 처리한 관리자 ID
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([status])
  @@index([reporterUserId])
  @@index([reportedUserId])
}
